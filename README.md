# MVP 商城后台技术方案
word 技术方案文档来自 [第三阶段GO企业级项目实战开发全流程](https://github.com/yuanqinguo/flyfei)

## 一、需求分析
  后台管理系统有：
+ `系统配置`: 采用RBAC权限管理, 包括用户管理, 角色管理, 权限管理. 
+ `管理员`: 不同管理员需要对角色和权限进行分配. 菜单动态生成. 不提供注册功能, 只允许内置管理员账号.
+ `管理员登录`: 支持账号密码登录, 验证码登录, 飞书扫码登录, 忘记密码、重置密码.

## 二、技术选型
+ 数据库采用`MySQL` , 使用`GORM`作为ORM框架. 使用DB First方式进行开发. 使用`Redis`作为缓存数据库.
+ 后端采用`Go`语言开发, 封装标准库的`net/http`包, 使用`Gin`框架的中间件与路由等功能.
+ 配置支持基础的本地`yaml`配置文件, 使用`Viper`进行配置管理, 支持`ETCD`配置中心.
+ 日志采用`zap`进行日志管理.

## 三、系统架构设计
系统架构设计见 [系统架构设计图](assets/Architecture.png)  
前后端分离架构设计, 后端提供RESTful API接口, 前端采用`Vue3`进行开发. 重点在后端设计.  
后端采用分层架构设计, 包括以下几层:
+ HTTP路由层: 负责处理HTTP请求, 制作中间件(日志、认证等中间件), 路由分组管理, 路由到控制器的映射. 
+ 控制器层: 负责处理请求参数校验, 认证管理, 调用服务层业务逻辑, 返回响应结果. 封装统一响应格式、错误码处理.
+ 服务层: 负责具体业务逻辑处理, 调用数据访问层进行数据操作, 调用第三方服务API等.
+ 数据访问层: 提供对数据库的操作(GORM), Redis缓存操作, 远程RPC服务调用, 如飞书API调用, 腾讯云COS文件上传等.
+ 中间件层: 提供日志记录、认证授权、错误处理等中间件功能.
+ 配置管理层: 使用Viper进行配置管理, 支持本地yaml文件和ETCD配置中心.
+ 工具库层: 提供通用工具函数, 随机数生成、日志封装、 滑块生成与处理、 UUID生成等.
+ 常量层: 定义系统常量, 错误码定义等.

## 四、模块设计
各个模块职责相对独立, 考虑后续服务差分.
+ 管理员(RBAC):
  1. 内置管理员(不可删除)、其他管理员
  2. 手机号+密码登录, 验证码登录
  3. 飞书扫码登录(对接飞书开放平台API), 需要管理员登录后绑定飞书账号才能登录.
  4. 忘记密码、重置密码
+ 系统配置:
  1. 角色管理: 角色的增删改查, 分配权限
  2. 权限管理: 权限的增删改查. 包括菜单权限和功能权限.
  3. 商品管理: 后台管理和上传商品. 将文件上传到腾讯云COS.
+ 商品管理:
  1. 商品管理: 目录分类, 商品增改查, 上下架, 对接COS.
+ 其他:
  1. 验证码服务, 将验证码发送到飞书消息替代短信.
  2. 文件上传服务, 对接腾讯云COS进行文件上传和管理.
  3. 滑块校验服务, 登录相关接口防刷.

## 五、数据库设计
数据库表设计见 [数据库设计文档](docs/db/README.md)  
+ `admin_user`: 管理员用户表
+ `permission`: 权限表
+ `role`: 角色表
+ `role_permission`: 角色权限关联表
+ `admin_user_role`: 管理员用户角色关联表
+ `lesson_category` : 课程分类目录表
+ `lessons` : 课程表
+ `resource_upload_files` : 云储存的资源记录表

## 六、接口设计
接口设计见 [接口设计文档](docs/api/README.md)
+ 管理员登录相关接口
+ 管理员用户管理接口
+ 角色管理接口
+ 权限管理接口
+ 商品管理接口(包含文件上传)

## 七、业务流程学习
业务流程图: [传送门](assets/业务流程.png)
业务流程学习见 [业务流程学习文档](docs/workflow/README.md)
除了简单的CRUD接口,主要学习以下业务流程:
+ 包含滑块校验的登录流程
+ 第三方飞书扫码登录流程, Github登录流程. 本质是 `OAuth2.0` 授权码模式流程.
+ RBAC 权限分配的逻辑和动态菜单和功能生成流程
+ 文件上传到腾讯云 COS的流程以及访问控制的流程
+ 接口数据处理流程